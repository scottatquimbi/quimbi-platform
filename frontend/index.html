<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linda's Quilting Store - Customer Intelligence Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 1400px;
            height: 90vh;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr auto;
            overflow: hidden;
        }

        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-section {
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        .message {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 80%;
        }

        .message.user {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message.assistant {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
        }

        .message.assistant .message-content {
            background: #f3f4f6;
            color: #1f2937;
        }

        .message-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            flex-shrink: 0;
        }

        .quick-buttons {
            display: flex;
            gap: 8px;
            padding: 0 20px 12px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .quick-button {
            padding: 8px 14px;
            background: #f8fafc;
            border: 2px solid #1e3a8a;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #1e3a8a;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-button:hover {
            background: #1e3a8a;
            color: white;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            border-color: #667eea;
        }

        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .debug-section {
            display: flex;
            flex-direction: column;
            background: #f9fafb;
            overflow: hidden;
        }

        .debug-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .debug-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
        }

        .debug-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .debug-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            min-height: 0;
        }

        .debug-panel {
            display: none;
        }

        .debug-panel.active {
            display: block;
        }

        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.5;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .json-key {
            color: #60a5fa;
        }

        .json-string {
            color: #34d399;
        }

        .json-number {
            color: #fbbf24;
        }

        .json-boolean {
            color: #f472b6;
        }

        .empty-state {
            text-align: center;
            color: #9ca3af;
            padding: 40px;
            font-size: 14px;
        }

        .loading {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: loading 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }

        .loading:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes loading {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üéØ Customer Intelligence Platform</h1>
                <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">
                    AI-powered behavioral segmentation & predictive analytics
                </div>
            </div>
            <div class="status">
                <span class="status-dot"></span>
                <span id="status-text">Connected</span>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="chat-section">
            <div class="messages" id="messages">
                <div class="message assistant">
                    <div class="message-label">Assistant</div>
                    <div class="message-content">
                        üëã Hi! I'm your customer intelligence assistant. I can help you understand customer behavior, archetypes, and patterns.
                        <br><br>
                        Try asking: "Show me a random customer" or "What are the top archetypes?"
                    </div>
                </div>
            </div>

            <div class="quick-buttons">
                <button class="quick-button" onclick="getRandomCustomer()">
                    üé≤ Random Customer
                </button>
                <button class="quick-button" onclick="sendQuickQuery('churn')">
                    üìä Check Churn Risk
                </button>
                <button class="quick-button" onclick="sendQuickQuery('top_archetypes')">
                    üèÜ Top Archetypes
                </button>
            </div>

            <div class="input-area">
                <input
                    type="text"
                    id="user-input"
                    placeholder="Ask about customers, archetypes, or behavior patterns..."
                    onkeypress="handleKeyPress(event)"
                />
                <button id="send-button" onclick="sendMessage()">Send</button>
            </div>
        </div>

        <!-- Debug Section -->
        <div class="debug-section">
            <div class="debug-tabs">
                <button class="debug-tab active" onclick="switchTab('request')">Request ‚Üí</button>
                <button class="debug-tab" onclick="switchTab('response')">‚Üê Response</button>
            </div>
            <div class="debug-content">
                <div id="request-panel" class="debug-panel active">
                    <div class="empty-state">Send a message to see the API request</div>
                </div>
                <div id="response-panel" class="debug-panel">
                    <div class="empty-state">Response will appear here</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://ecommerce-backend-staging-a14c.up.railway.app';

        function switchTab(tab) {
            document.querySelectorAll('.debug-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.debug-panel').forEach(p => p.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + '-panel').classList.add('active');
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            messageDiv.innerHTML = `
                <div class="message-label">${role === 'user' ? 'You' : 'Assistant'}</div>
                <div class="message-content">${content}</div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addLoadingMessage() {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = 'loading-message';

            messageDiv.innerHTML = `
                <div class="message-label">Assistant</div>
                <div class="message-content">
                    <span class="loading"></span>
                    <span class="loading"></span>
                    <span class="loading"></span>
                </div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg) {
                loadingMsg.remove();
            }
        }

        function formatJSON(json) {
            return JSON.stringify(json, null, 2)
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1":</span>')
                .replace(/: "([^"]*)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/: (\d+\.?\d*)/g, ': <span class="json-number">$1</span>')
                .replace(/: (true|false|null)/g, ': <span class="json-boolean">$1</span>');
        }

        function updateDebugPanel(panel, data, title) {
            const panelDiv = document.getElementById(panel + '-panel');
            panelDiv.innerHTML = `
                <div style="margin-bottom: 12px; font-weight: 600; color: #374151;">${title}</div>
                <pre>${formatJSON(data)}</pre>
            `;
        }

        async function parseUserQuery(text) {
            const lowerText = text.toLowerCase();

            // Check for churn risk queries FIRST (more specific)
            if ((lowerText.includes('churn') || lowerText.includes('risk')) && lowerText.match(/\d{13}/)) {
                const customerId = text.match(/\d{13}/)[0];
                return {
                    endpoint: `/api/mcp/customer/${customerId}/churn-risk`,
                    method: 'GET',
                    description: `Churn risk for customer ${customerId}`
                };
            }

            // Customer profile queries (more general)
            if (lowerText.match(/\d{13}/)) {
                const customerId = text.match(/\d{13}/)[0];
                return {
                    endpoint: `/api/mcp/customer/${customerId}`,
                    method: 'GET',
                    description: `Customer profile for ${customerId}`
                };
            }

            // Archetype queries
            if (lowerText.includes('arch_')) {
                const archetypeId = text.match(/arch_\d+/)[0];
                return {
                    endpoint: `/api/mcp/archetype/${archetypeId}`,
                    method: 'GET',
                    description: `Archetype stats for ${archetypeId}`
                };
            }

            // Natural language business questions (holiday/seasonal, complex queries)
            if ((lowerText.includes('holiday') || lowerText.includes('seasonal') || lowerText.includes('season')) &&
                (lowerText.includes('archetype') || lowerText.includes('segment') || lowerText.includes('focus'))) {
                return {
                    endpoint: `/api/mcp/query/natural-language`,
                    method: 'POST',
                    body: { query: text },
                    description: 'Natural language query: seasonal archetype recommendation'
                };
            }

            // Natural language: Revenue forecast
            if ((lowerText.includes('revenue') || lowerText.includes('sales')) &&
                (lowerText.includes('forecast') || lowerText.includes('predict') || lowerText.includes('what will'))) {
                return {
                    endpoint: `/api/mcp/query/natural-language`,
                    method: 'POST',
                    body: { query: text },
                    description: 'Natural language query: revenue forecast'
                };
            }

            // Natural language: Campaign targeting (complex)
            if ((lowerText.includes('who should') || lowerText.includes('which customers')) &&
                (lowerText.includes('target') || lowerText.includes('campaign') || lowerText.includes('focus'))) {
                return {
                    endpoint: `/api/mcp/query/natural-language`,
                    method: 'POST',
                    body: { query: text },
                    description: 'Natural language query: campaign targeting'
                };
            }

            // Archetype-segmented growth projection queries
            if ((lowerText.includes('archetype') || lowerText.includes('segment')) &&
                (lowerText.includes('grow') || lowerText.includes('growth') ||
                 lowerText.includes('churn') || lowerText.includes('projection') ||
                 lowerText.includes('break') || lowerText.includes('by archetype'))) {
                // Extract timeframe
                let months = 12;
                if (lowerText.includes('6 months') || lowerText.includes('six months')) {
                    months = 6;
                } else if (lowerText.includes('2 years') || lowerText.includes('two years')) {
                    months = 24;
                } else if (lowerText.includes('18 months')) {
                    months = 18;
                }

                return {
                    endpoint: `/api/mcp/archetypes/growth-projection?months=${months}&top_n=10`,
                    method: 'GET',
                    description: `Archetype growth projection over ${months} months`
                };
            }

            // Customer growth projection queries
            if ((lowerText.includes('how many') || lowerText.includes('what will')) &&
                (lowerText.includes('customers') || lowerText.includes('customer base') ||
                 lowerText.includes('users') || lowerText.includes('user base')) &&
                (lowerText.includes('will we have') || lowerText.includes('will there be') ||
                 lowerText.includes('in one year') || lowerText.includes('in a year') ||
                 lowerText.includes('next year') || lowerText.includes('growth'))) {
                // Extract timeframe (default to 12 months for "one year")
                let months = 12;
                if (lowerText.includes('6 months') || lowerText.includes('six months')) {
                    months = 6;
                } else if (lowerText.includes('2 years') || lowerText.includes('two years')) {
                    months = 24;
                } else if (lowerText.includes('18 months')) {
                    months = 18;
                }

                return {
                    endpoint: `/api/mcp/growth/projection?months=${months}`,
                    method: 'GET',
                    description: `Customer growth projection over ${months} months`
                };
            }

            // Aggregate churn prediction queries
            if ((lowerText.includes('how many') || lowerText.includes('what percentage') ||
                 lowerText.includes('how much')) &&
                (lowerText.includes('churn') || lowerText.includes('leave') ||
                 lowerText.includes('at risk') || lowerText.includes('will stop'))) {
                return {
                    endpoint: '/api/mcp/churn/aggregate',
                    method: 'GET',
                    description: 'Aggregate churn prediction analysis'
                };
            }

            // "Who buys the most" / "top customers" / "top archetypes" queries
            if (lowerText.includes('buys the most') || lowerText.includes('top customer') ||
                lowerText.includes('highest value') || lowerText.includes('top archetype') ||
                (lowerText.includes('top') && lowerText.includes('money'))) {

                // Determine metric based on query
                let metric = 'total_ltv';  // Default
                if (lowerText.includes('average') || lowerText.includes('avg')) {
                    metric = 'avg_ltv';
                } else if (lowerText.includes('largest') || lowerText.includes('biggest') ||
                          lowerText.includes('most members')) {
                    metric = 'member_count';
                }

                return {
                    endpoint: `/api/mcp/archetypes/top?metric=${metric}&limit=10`,
                    method: 'GET',
                    description: `Top archetypes by ${metric}`
                };
            }

            // Default to health check
            return {
                endpoint: '/health',
                method: 'GET',
                description: 'API health check'
            };
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            addMessage('user', message);
            input.value = '';
            sendButton.disabled = true;

            // Add loading indicator
            addLoadingMessage();

            try {
                // Parse user query
                const query = await parseUserQuery(message);

                // Check if custom handler
                if (query.customHandler) {
                    const requestData = {
                        type: 'custom_analysis',
                        query: message
                    };
                    updateDebugPanel('request', requestData, 'üì§ Custom Query Analysis');

                    const result = await query.customHandler();
                    updateDebugPanel('response', result, 'üì• Analysis Result');

                    removeLoadingMessage();
                    addMessage('assistant', result.answer);
                } else {
                    // Build request
                    let url = API_BASE_URL + query.endpoint;

                    // Handle POST with query body
                    let fetchOptions = {
                        method: query.method || 'GET',
                        headers: {}
                    };

                    if (query.body) {
                        // For POST with query parameter
                        const params = new URLSearchParams(query.body);
                        url += '?' + params.toString();
                    }

                    const requestData = {
                        url: url,
                        method: fetchOptions.method,
                        description: query.description
                    };

                    updateDebugPanel('request', requestData, 'üì§ API Request');

                    // Make API call
                    const response = await fetch(url, fetchOptions);
                    const data = await response.json();

                    // Update response panel
                    updateDebugPanel('response', data, 'üì• API Response');

                    // Remove loading and add response
                    removeLoadingMessage();

                    // Format response as message
                    let responseText = formatResponse(data, query.description);
                    addMessage('assistant', responseText);
                }

            } catch (error) {
                removeLoadingMessage();
                addMessage('assistant', `‚ùå Error: ${error.message}`);
                console.error('Error:', error);
            }

            sendButton.disabled = false;
        }

        // Helper function to anonymize customer IDs
        function anonymizeCustomerId(customerId) {
            if (!customerId) return 'N/A';
            // Hash the ID to create a consistent but anonymized version
            let hash = 0;
            for (let i = 0; i < customerId.length; i++) {
                hash = ((hash << 5) - hash) + customerId.charCodeAt(i);
                hash = hash & hash;
            }
            return 'C-' + Math.abs(hash).toString(16).toUpperCase().substring(0, 8);
        }

        function formatResponse(data, description) {
            if (data.customer_id) {
                // Customer profile
                const ltv = data.business_metrics?.lifetime_value || 0;
                const orders = data.business_metrics?.total_orders || 0;
                const traits = data.archetype?.behavioral_traits?.slice(0, 5).join('<br>  ‚Ä¢ ') || 'N/A';
                const anonId = anonymizeCustomerId(data.customer_id);

                return `
                    <strong>Customer Profile</strong><br>
                    üîë Customer ID: ${anonId}<br>
                    üí∞ Lifetime Value: $${ltv.toLocaleString()}<br>
                    üì¶ Total Orders: ${orders}<br>
                    üéØ Archetype: ${data.archetype?.archetype_id || 'N/A'}<br><br>
                    <strong>Behavioral Traits:</strong><br>
                    ‚Ä¢ ${traits}
                `;
            }

            if (data.risk_level) {
                // Churn risk
                return `
                    <strong>Churn Risk Analysis</strong><br>
                    ‚ö†Ô∏è Risk Level: ${data.risk_level.toUpperCase()}<br>
                    üìä Risk Score: ${(data.churn_risk_score * 100).toFixed(0)}%<br>
                    üí° Recommendation: ${data.recommendation}
                `;
            }

            if (data.projected_customers) {
                // Growth projection
                const growthIcon = data.growth_rate_pct > 0 ? 'üìà' : 'üìâ';
                const growthColor = data.growth_rate_pct > 0 ? 'green' : 'red';
                return `
                    <strong>üìä Customer Growth Projection</strong><br>
                    üìÖ Timeframe: ${data.timeframe_months} months<br>
                    ${growthIcon} Projected Growth Rate: <span style="color: ${growthColor}; font-weight: bold;">${data.growth_rate_pct > 0 ? '+' : ''}${data.growth_rate_pct}%</span><br><br>
                    <strong>Assumptions:</strong><br>
                    ‚ö†Ô∏è Monthly Churn Rate: ${data.assumptions.monthly_churn_rate_pct}%<br>
                    üë§ Avg Customer Tenure: ${data.assumptions.avg_customer_tenure_days.toLocaleString()} days<br>
                    üìä Data Span: ${data.assumptions.data_span_years} years<br><br>
                    <em style="font-size: 12px; opacity: 0.8;">Analysis based on historical acquisition patterns and behavioral churn predictions</em>
                `;
            }

            if (data.churn_risk_distribution) {
                // Aggregate churn analysis
                const dist = data.churn_risk_distribution;
                const sample_size = data.sample_size.toLocaleString();
                return `
                    <strong>üìä Aggregate Churn Risk Analysis</strong><br>
                    üî¨ Analysis Sample: ${sample_size} customers<br><br>
                    <strong>Risk Distribution:</strong><br>
                    üî¥ High Risk: ${dist.high_risk.percentage}% of customer base<br>
                    üü° Medium Risk: ${dist.medium_risk.percentage}% of customer base<br>
                    üü¢ Low Risk: ${dist.low_risk.percentage}% of customer base<br><br>
                    <strong>Key Metrics:</strong><br>
                    ‚ö†Ô∏è 30-Day Churn Risk: ~${dist.high_risk.percentage}% of base<br>
                    ‚ö†Ô∏è 90-Day Churn Risk: ~${(dist.high_risk.percentage + dist.medium_risk.percentage * 0.3).toFixed(2)}% of base<br><br>
                    <em style="font-size: 12px; opacity: 0.8;">Based on behavioral churn prediction model analyzing ${sample_size} customer sample</em>
                `;
            }

            if (data.archetype_projections && Array.isArray(data.archetype_projections)) {
                // Archetype growth projections
                let archetypeList = '';
                data.archetype_projections.forEach((arch, idx) => {
                    const growthIcon = arch.growth_rate_pct > 0 ? 'üìà' : (arch.growth_rate_pct < 0 ? 'üìâ' : '‚û°Ô∏è');
                    const growthColor = arch.growth_rate_pct > 0 ? 'green' : (arch.growth_rate_pct < 0 ? 'red' : 'gray');
                    const segments = Object.entries(arch.dominant_segments || {})
                        .slice(0, 3)
                        .map(([axis, segment]) => segment)
                        .join(', ');

                    archetypeList += `
                        <div style="margin-bottom: 12px; padding: 10px; background: #f9fafb; border-left: 3px solid ${growthColor}; border-radius: 4px;">
                            <strong>#${idx + 1}: ${arch.archetype_id}</strong> ${growthIcon}<br>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 6px; font-size: 13px;">
                                <div>
                                    üí∞ Total LTV: $${arch.total_ltv.toLocaleString()}<br>
                                    üìä Growth Rate: <span style="color: ${growthColor}; font-weight: bold;">${arch.growth_rate_pct > 0 ? '+' : ''}${arch.growth_rate_pct}%</span><br>
                                    ‚ö†Ô∏è Churn Rate: ${arch.monthly_churn_rate_pct}%/mo
                                </div>
                                <div>
                                    üìà Net Change: ${arch.growth_rate_pct > 0 ? '+' : ''}${arch.growth_rate_pct}%<br>
                                    üéØ Relative Size: ${((arch.current_members / data.archetype_projections[0].current_members) * 100).toFixed(1)}%<br>
                                    <em style="font-size: 10px; color: #9ca3af;">(vs largest segment)</em>
                                </div>
                            </div>
                            <em style="font-size: 11px; color: #6b7280;">${segments}</em>
                        </div>
                    `;
                });

                return `
                    <strong>üìä Archetype Growth Projection (${data.timeframe_months} months)</strong><br>
                    üéØ Top ${data.archetypes_analyzed} Archetypes by Value<br>
                    üìä Analysis Period: ${data.global_assumptions.data_span_years} years of data<br><br>
                    ${archetypeList}
                `;
            }

            if (data.top_archetypes && Array.isArray(data.top_archetypes)) {
                // Top archetypes ranking
                const metricLabel = {
                    'total_ltv': 'Total Lifetime Value',
                    'avg_ltv': 'Average LTV per Customer',
                    'member_count': 'Member Count'
                }[data.metric] || data.metric;

                let archetypeList = '';
                data.top_archetypes.forEach((arch, idx) => {
                    const segments = Object.entries(arch.dominant_segments || {})
                        .map(([axis, segment]) => `${axis}:${segment}`)
                        .join(', ');

                    archetypeList += `
                        <div style="margin-bottom: 12px; padding: 8px; background: #f9fafb; border-radius: 6px;">
                            <strong>#${idx + 1}: ${arch.archetype_id}</strong><br>
                            üí∞ Total LTV: $${arch.total_lifetime_value.toLocaleString()}<br>
                            üë• Members: ${arch.member_count.toLocaleString()} (${arch.population_percentage}%)<br>
                            üìä Avg LTV: $${arch.avg_lifetime_value.toLocaleString()}<br>
                            <em style="font-size: 11px;">${segments}</em>
                        </div>
                    `;
                });

                return `
                    <strong>üèÜ Top Archetypes by ${metricLabel}</strong><br>
                    üìä Total Archetypes Analyzed: ${data.total_archetypes}<br>
                    üë• Top ${data.top_archetypes.length} represent ${data.summary.top_archetype_population_pct}% of customers<br>
                    üí∞ Combined LTV: $${data.summary.top_archetype_total_ltv.toLocaleString()}<br><br>
                    ${archetypeList}
                `;
            }

            if (data.query_type && data.answer) {
                // Natural language query response
                const answer = data.answer;

                // Seasonal archetype recommendation
                if (data.query_type === 'seasonal_archetype_recommendation') {
                    let archetypeList = '';
                    answer.top_archetypes.forEach((arch, idx) => {
                        const segments = Object.entries(arch.dominant_segments || {})
                            .slice(0, 3)
                            .map(([axis, segment]) => `${segment}`)
                            .join(', ');

                        archetypeList += `
                            <div style="margin-bottom: 10px; padding: 10px; background: #f0f9ff; border-left: 3px solid #3b82f6; border-radius: 4px;">
                                <strong>#${idx + 1}: ${arch.archetype_id}</strong> (Score: ${arch.score})<br>
                                üí∞ Total LTV: $${arch.total_ltv.toLocaleString()}<br>
                                üìä Members: ${arch.population_percentage}% of customer base<br>
                                ‚ú® Why: ${arch.recommendation_reasons.join(', ')}<br>
                                <em style="font-size: 11px; color: #6b7280;">${segments}</em>
                            </div>
                        `;
                    });

                    return `
                        <strong>üéÑ Holiday Season Archetype Recommendations</strong><br>
                        ${answer.summary}<br><br>
                        ${archetypeList}
                        <br><strong>üìã Campaign Strategy:</strong><br>
                        ‚è∞ Timing: ${answer.campaign_strategy.timing}<br>
                        üí¨ Messaging: ${answer.campaign_strategy.messaging}<br>
                        üì¢ Channels: ${answer.campaign_strategy.channels}<br>
                        üéÅ Offers: ${answer.campaign_strategy.offers}<br>
                        üí∞ ${answer.campaign_strategy.expected_roi}
                    `;
                }

                // Churn identification
                if (data.query_type === 'churn_identification') {
                    const dist = answer.churn_distribution;
                    let customerList = '';
                    answer.top_at_risk_customers.slice(0, 10).forEach((cust, idx) => {
                        const anonId = anonymizeCustomerId(cust.customer_id);
                        customerList += `
                            <div style="padding: 6px; background: #fef2f2; border-left: 2px solid #ef4444; margin-bottom: 6px; border-radius: 3px; font-size: 13px;">
                                #${idx + 1}: ${anonId} | LTV: $${cust.ltv.toLocaleString()} | Risk: ${(cust.churn_risk * 100).toFixed(0)}%
                            </div>
                        `;
                    });

                    return `
                        <strong>‚ö†Ô∏è Churn Risk Analysis</strong><br>
                        ${answer.summary}<br><br>
                        <strong>Distribution:</strong><br>
                        üî¥ High Risk: ${dist.high_risk.percentage}%<br>
                        üü° Medium Risk: ${dist.medium_risk.percentage}%<br>
                        üü¢ Low Risk: ${dist.low_risk.percentage}%<br><br>
                        <strong>Top 10 At-Risk Customers:</strong><br>
                        ${customerList}
                        <br>üí° ${answer.recommended_action}
                    `;
                }

                // Revenue forecast
                if (data.query_type === 'revenue_forecast') {
                    return `
                        <strong>üí∞ Revenue Forecast</strong><br>
                        ${answer.summary}<br><br>
                        <strong>Key Insights:</strong><br>
                        ${answer.key_insights.map(insight => `‚Ä¢ ${insight}`).join('<br>')}<br><br>
                        <em style="font-size: 12px; opacity: 0.8;">Based on customer LTV forecasting with retention modeling</em>
                    `;
                }

                // Campaign targeting
                if (data.query_type === 'campaign_targeting') {
                    let customerList = '';
                    answer.recommended_customers.slice(0, 10).forEach((cust, idx) => {
                        const anonId = anonymizeCustomerId(cust.customer_id);
                        customerList += `
                            <div style="padding: 6px; background: #f0fdf4; border-left: 2px solid #22c55e; margin-bottom: 6px; border-radius: 3px; font-size: 13px;">
                                #${idx + 1}: ${anonId} | LTV: $${cust.ltv.toLocaleString()} | Score: ${cust.score.toFixed(0)}
                            </div>
                        `;
                    });

                    return `
                        <strong>üéØ Campaign Targeting: ${answer.campaign_type}</strong><br>
                        ${answer.summary}<br><br>
                        <strong>Top 10 Recommended Customers:</strong><br>
                        ${customerList}
                        <br>üí° Strategy: ${answer.strategy}
                    `;
                }

                // Archetype growth projection
                if (data.query_type === 'archetype_growth_projection') {
                    return `
                        <strong>üìä ${answer.summary}</strong><br><br>
                        <strong>Key Insights:</strong><br>
                        ${answer.key_insights.map(insight => `‚Ä¢ ${insight}`).join('<br>')}<br><br>
                        <em style="font-size: 12px; opacity: 0.8;">See response panel for detailed projections</em>
                    `;
                }

                // Unsupported query
                if (data.query_type === 'unsupported') {
                    return `
                        <strong>‚ùì ${answer.message}</strong><br><br>
                        ${answer.supported_queries.map(q => `‚Ä¢ ${q}`).join('<br>')}
                    `;
                }
            }

            if (data.status && data.data_status) {
                // Health check
                return `
                    <strong>System Status</strong><br>
                    ‚úÖ API Status: ${data.status}<br>
                    üéØ Behavioral Archetypes: ${data.data_status.archetypes_available} identified<br>
                    üíæ Data Source: ${data.data_status.data_source}<br>
                    ü§ñ AI Model: Predictive behavioral segmentation
                `;
            }

            // Generic response
            return '<pre style="background: #f3f4f6; color: #1f2937; padding: 12px; border-radius: 6px; font-size: 12px;">' +
                   JSON.stringify(data, null, 2) + '</pre>';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        let currentCustomerId = null;

        async function getRandomCustomer() {
            const input = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');

            sendButton.disabled = true;
            addMessage('user', 'üé≤ Show me a random customer');
            addLoadingMessage();

            try {
                // Fetch a random customer from the API
                const url = API_BASE_URL + '/api/mcp/customer/random';
                const requestData = {
                    url: url,
                    method: 'GET',
                    description: 'Get random customer profile'
                };

                updateDebugPanel('request', requestData, 'üì§ API Request');

                const response = await fetch(url);
                const data = await response.json();

                // Store the customer ID for subsequent queries
                currentCustomerId = data.customer_id;

                updateDebugPanel('response', data, 'üì• API Response');
                removeLoadingMessage();

                const responseText = formatResponse(data, 'Random customer profile');
                addMessage('assistant', responseText);

            } catch (error) {
                removeLoadingMessage();
                addMessage('assistant', `‚ùå Error: ${error.message}`);
                console.error('Error:', error);
            }

            sendButton.disabled = false;
        }

        async function sendQuickQuery(type) {
            const input = document.getElementById('user-input');

            if (type === 'churn') {
                // Use the current customer ID if available, otherwise use default
                const customerId = currentCustomerId || '5971333382399';
                input.value = `What is the churn risk for customer ${customerId}?`;
            } else if (type === 'top_archetypes') {
                input.value = 'What type of person buys the most?';
            }

            sendMessage();
        }

        // Check API health on load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(API_BASE_URL + '/health');
                const data = await response.json();

                if (data.status === 'healthy') {
                    document.getElementById('status-text').textContent =
                        'Connected ‚Ä¢ ' + data.data_status.customers_loaded.toLocaleString() + ' customers loaded';
                } else {
                    document.getElementById('status-text').textContent = 'Connected (degraded)';
                }
            } catch (error) {
                document.getElementById('status-text').textContent = 'Connection error';
                document.querySelector('.status-dot').style.background = '#ef4444';
            }
        });
    </script>
</body>
</html>
